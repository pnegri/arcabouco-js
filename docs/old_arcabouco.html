<!DOCTYPE html>  <html> <head>   <title>old_arcabouco.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="_monkey-fs.html">                 _monkey-fs.coffee               </a>                                           <a class="source" href="_monkey-patching.html">                 _monkey-patching.coffee               </a>                                           <a class="source" href="arcabouco.html">                 arcabouco.coffee               </a>                                           <a class="source" href="arcabouco_content.html">                 arcabouco_content.coffee               </a>                                           <a class="source" href="arcabouco_controller.html">                 arcabouco_controller.coffee               </a>                                           <a class="source" href="arcabouco_object_pool.html">                 arcabouco_object_pool.coffee               </a>                                           <a class="source" href="arcabouco_request.html">                 arcabouco_request.coffee               </a>                                           <a class="source" href="arcabouco_template.html">                 arcabouco_template.coffee               </a>                                           <a class="source" href="common.html">                 common.coffee               </a>                                           <a class="source" href="old_arcabouco.html">                 old_arcabouco.coffee               </a>                                           <a class="source" href="template.html">                 template.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               old_arcabouco.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Common = </span><span class="nx">require</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s">&#39;/common&#39;</span>
<span class="nv">Underscore = </span><span class="nx">require</span> <span class="s">&#39;underscore&#39;</span>
<span class="nx">require</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s">&#39;/_monkey-patching&#39;</span>
<span class="p">{</span><span class="nx">spawn</span><span class="p">,</span> <span class="nx">exec</span><span class="p">}</span>  <span class="o">=</span> <span class="nx">require</span> <span class="s">&#39;child_process&#39;</span>

<span class="nv">Template = </span><span class="nx">require</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s">&#39;/template&#39;</span>

<span class="k">class</span> <span class="nx">PublicExposer</span>
  <span class="nv">piecesArray         : </span><span class="p">[]</span>

  <span class="nv">addPiece: </span><span class="nf">( pieceFilename, options ) -&gt;</span>
    <span class="nv">priority = </span><span class="mi">0</span>
    <span class="nv">priority = </span><span class="nx">options</span><span class="p">.</span><span class="nx">priority</span> <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">priority</span>

    <span class="nx">@piecesArray</span><span class="p">.</span><span class="nx">push</span>
      <span class="nv">filename: </span><span class="nx">pieceFilename</span>
      <span class="nv">priority: </span><span class="nx">priority</span>

  <span class="nv">build: </span><span class="nf">(application, development=false) -&gt;</span>

    <span class="nv">piecesByPriority = </span><span class="nx">Underscore</span><span class="p">.</span><span class="nx">sortBy</span> <span class="nx">@piecesArray</span><span class="p">,</span>
      <span class="nf">( obj ) -&gt;</span>
        <span class="k">return</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">priority</span>

    <span class="nv">outputDir = </span><span class="nx">application</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">baseDirectory</span> <span class="o">+</span> <span class="s">&#39;/cdn/js&#39;</span>

    <span class="nv">c = </span><span class="mi">0</span>
    <span class="k">for</span> <span class="nx">pieceDetails</span> <span class="k">in</span> <span class="nx">piecesByPriority</span>
      <span class="nv">pieceFilename = </span><span class="nx">pieceDetails</span><span class="p">.</span><span class="nx">filename</span>
      
      <span class="nv">baseFilename = </span><span class="nx">Common</span><span class="p">.</span><span class="nx">Path</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span> <span class="nx">pieceFilename</span><span class="p">,</span> <span class="s">&#39;.coffee&#39;</span> <span class="p">)</span> <span class="o">+</span> <span class="s">&#39;-&#39;</span> <span class="o">+</span> <span class="nx">c</span>

      <span class="nx">exec</span> <span class="s">&quot;coffee --compile -p </span><span class="si">#{</span><span class="nx">pieceFilename</span><span class="si">}</span><span class="s"> &gt; </span><span class="si">#{</span><span class="nx">outputDir</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">baseFilename</span><span class="si">}</span><span class="s">.js&quot;</span>

      <span class="nx">application</span><span class="p">.</span><span class="nx">ContentGenerator</span><span class="p">.</span><span class="nx">addContentFor</span> <span class="s">&#39;head&#39;</span><span class="p">,</span>
        <span class="s">&quot;&lt;script src=\&quot;/cdn/js/</span><span class="si">#{</span><span class="nx">baseFilename</span><span class="si">}</span><span class="s">.js\&quot;&gt;&lt;/script&gt;&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nv">priority: </span><span class="nx">pieceDetails</span><span class="p">.</span><span class="nx">priority</span> <span class="p">}</span>

      <span class="nv">c = </span><span class="nx">c</span><span class="o">+</span><span class="mi">1</span>


<span class="k">class</span> <span class="nx">ContentGenerator</span>
  <span class="nv">contentArray        : </span><span class="p">[]</span>

  <span class="nv">ensureArray: </span><span class="nf">( where, group ) -&gt;</span>
    <span class="nx">@contentArray</span><span class="p">[</span> <span class="nx">group</span> <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="nx">unless</span> <span class="nx">@contentArray</span><span class="p">[</span> <span class="nx">group</span> <span class="p">]</span>
    <span class="nx">@contentArray</span><span class="p">[</span> <span class="nx">group</span> <span class="p">][</span> <span class="nx">where</span> <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="nx">unless</span> <span class="nx">@contentArray</span><span class="p">[</span> <span class="nx">group</span> <span class="p">][</span> <span class="nx">where</span> <span class="p">]</span>
    <span class="kc">true</span>

  <span class="nv">addContentFor: </span><span class="nf">( where, data, options = { group: &#39;default&#39; } ) -&gt;</span>
    <span class="nv">priority = </span><span class="mi">0</span>
    <span class="nv">priority = </span><span class="nx">options</span><span class="p">.</span><span class="nx">priority</span> <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">priority</span>

    <span class="nv">group = </span><span class="s">&#39;default&#39;</span>
    <span class="nv">group = </span><span class="nx">options</span><span class="p">.</span><span class="nx">group</span> <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">group</span>

    <span class="nx">@ensureArray</span><span class="p">(</span> <span class="nx">where</span><span class="p">,</span> <span class="nx">group</span> <span class="p">)</span>

    <span class="nv">type = </span><span class="s">&#39;plain&#39;</span>
    <span class="nv">type = </span><span class="s">&#39;function&#39;</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">data</span> <span class="o">==</span> <span class="s">&#39;function&#39;</span>

    <span class="nx">@contentArray</span><span class="p">[</span> <span class="nx">group</span> <span class="p">][</span> <span class="nx">where</span> <span class="p">].</span><span class="nx">push</span>
      <span class="s">&#39;type&#39;</span><span class="o">:</span> <span class="nx">type</span>
      <span class="nv">data: </span><span class="nx">data</span>
      <span class="nv">priority: </span><span class="nx">priority</span>

  <span class="nv">getContentFor: </span><span class="nf">( where, options = { group: &#39;default&#39; } ) -&gt;</span>
    <span class="nv">group = </span><span class="nx">options</span><span class="p">.</span><span class="nx">group</span>

    <span class="nx">@ensureArray</span><span class="p">(</span> <span class="nx">where</span><span class="p">,</span> <span class="nx">group</span> <span class="p">)</span>

    <span class="nv">content = </span><span class="s">&#39;&#39;</span>
    <span class="nv">priorityArray = </span><span class="nx">Underscore</span><span class="p">.</span><span class="nx">sortBy</span> <span class="nx">@contentArray</span><span class="p">[</span> <span class="nx">group</span> <span class="p">][</span> <span class="nx">where</span> <span class="p">],</span>
      <span class="nf">( obj ) -&gt;</span>
        <span class="k">return</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">priority</span>

    <span class="k">for</span> <span class="nx">aContent</span> <span class="k">in</span> <span class="nx">priorityArray</span>
      <span class="nv">output = </span><span class="s">&#39;&#39;</span>
      <span class="k">if</span> <span class="nx">aContent</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s">&#39;plain&#39;</span>
        <span class="nv">output = </span><span class="nx">aContent</span><span class="p">.</span><span class="nx">data</span>
      <span class="k">else</span>
        <span class="nv">output = </span><span class="nx">aContent</span><span class="p">.</span><span class="nx">data</span><span class="p">()</span>
      <span class="nx">content</span> <span class="o">+=</span> <span class="nx">output</span>
    <span class="nx">content</span>

<span class="k">class</span> <span class="nx">Arcabouco</span>
  <span class="nv">config              : </span><span class="p">{}</span>

  <span class="nv">Template            : </span><span class="kc">false</span>
  <span class="nv">ContentGenerator    : </span><span class="kc">false</span>
  <span class="nv">PublicExposer       : </span><span class="kc">false</span>

  <span class="nv">newRoutingAvaiable  : </span><span class="kc">false</span>
  <span class="nv">controllerInstances : </span><span class="p">[]</span>
  <span class="nv">routeToMethod       : </span><span class="p">[]</span>
  <span class="nv">avaiableRoutes      : </span><span class="p">[]</span>

  <span class="nv">_requestsCounter    : </span><span class="mi">0</span>
  <span class="nv">_requestsPolling    : </span><span class="mi">0</span>
  <span class="nv">requestsPerSecond   : </span><span class="mi">0</span>
  <span class="nv">_lastCPU            : </span><span class="p">{</span>
    <span class="nv">user: </span><span class="mi">0</span>
    <span class="nv">idle: </span><span class="mi">0</span>
    <span class="nv">sys: </span><span class="mi">0</span>
    <span class="nv">irq: </span><span class="mi">0</span>
    <span class="nv">nice: </span><span class="mi">0</span>
  <span class="p">}</span>

  <span class="nv">constructor         : </span><span class="nf">( @config ) -&gt;</span>
    <span class="nx">unless</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">baseDirectory</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;Configuration doesnt have baseDirectory directive&#39;</span>
      <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="nv">global.objects = </span><span class="p">[]</span>
    <span class="nv">global.public_exports = </span><span class="p">[]</span>

    <span class="vi">@Template = </span><span class="k">new</span> <span class="nx">Template</span><span class="p">()</span>
    <span class="vi">@ContentGenerator = </span><span class="k">new</span> <span class="nx">ContentGenerator</span><span class="p">()</span>
    <span class="vi">@PublicExposer = </span><span class="k">new</span> <span class="nx">PublicExposer</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>@content_for = @ContentGenerator.getContentFor</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@Template</span><span class="p">.</span><span class="nx">loadTemplate</span> <span class="nx">Common</span><span class="p">.</span><span class="nx">Path</span><span class="p">.</span><span class="nx">normalize</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s">&#39;/../templates/404.haml&#39;</span><span class="p">),</span> <span class="s">&#39;404&#39;</span>
    <span class="nx">@Template</span><span class="p">.</span><span class="nx">loadTemplate</span> <span class="nx">Common</span><span class="p">.</span><span class="nx">Path</span><span class="p">.</span><span class="nx">normalize</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s">&#39;/../templates/500.haml&#39;</span><span class="p">),</span> <span class="s">&#39;500&#39;</span>

    <span class="nx">setInterval</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>TODO: SEPARATE THIS INTO A CLASS</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="vi">@requestsPerSecond = </span><span class="nx">@_requestsCounter</span>
      <span class="vi">@_requestsCounter = </span><span class="mi">0</span>
      <span class="nv">totalMemory = </span><span class="nx">Common</span><span class="p">.</span><span class="nx">Os</span><span class="p">.</span><span class="nx">totalmem</span><span class="p">()</span>
      <span class="nv">freeMemory = </span><span class="nx">Common</span><span class="p">.</span><span class="nx">Os</span><span class="p">.</span><span class="nx">freemem</span><span class="p">()</span>
      <span class="nv">loadAverage = </span><span class="nx">Common</span><span class="p">.</span><span class="nx">Os</span><span class="p">.</span><span class="nx">loadavg</span><span class="p">()</span>

      <span class="nv">cpus = </span><span class="nx">Common</span><span class="p">.</span><span class="nx">Os</span><span class="p">.</span><span class="nx">cpus</span><span class="p">()</span>
      <span class="nv">user = </span><span class="mi">0</span>
      <span class="nv">nice = </span><span class="mi">0</span>
      <span class="nv">sys = </span><span class="mi">0</span>
      <span class="nv">idle = </span><span class="mi">0</span>
      <span class="nv">irq = </span><span class="mi">0</span>
      <span class="k">for</span> <span class="nx">cpu</span> <span class="k">in</span> <span class="nx">cpus</span>
        <span class="nx">user</span> <span class="o">+=</span> <span class="nx">cpu</span><span class="p">.</span><span class="nx">times</span><span class="p">.</span><span class="nx">user</span>
        <span class="nx">nice</span> <span class="o">+=</span> <span class="nx">cpu</span><span class="p">.</span><span class="nx">times</span><span class="p">.</span><span class="nx">nice</span>
        <span class="nx">sys</span> <span class="o">+=</span> <span class="nx">cpu</span><span class="p">.</span><span class="nx">times</span><span class="p">.</span><span class="nx">sys</span>
        <span class="nx">idle</span> <span class="o">+=</span> <span class="nx">cpu</span><span class="p">.</span><span class="nx">times</span><span class="p">.</span><span class="nx">idle</span>
        <span class="nx">irq</span> <span class="o">+=</span> <span class="nx">cpu</span><span class="p">.</span><span class="nx">times</span><span class="p">.</span><span class="nx">irq</span>
      <span class="nv">total = </span><span class="nx">user</span><span class="o">+</span><span class="nx">nice</span><span class="o">+</span><span class="nx">sys</span><span class="o">+</span><span class="nx">idle</span><span class="o">+</span><span class="nx">irq</span>

      <span class="nv">current_user = </span><span class="nx">user</span><span class="o">-</span><span class="nx">@_lastCPU</span><span class="p">.</span><span class="nx">user</span>
      <span class="nv">current_nice = </span><span class="nx">nice</span><span class="o">-</span><span class="nx">@_lastCPU</span><span class="p">.</span><span class="nx">nice</span>
      <span class="nv">current_sys = </span><span class="nx">sys</span><span class="o">-</span><span class="nx">@_lastCPU</span><span class="p">.</span><span class="nx">sys</span>
      <span class="nv">current_idle = </span><span class="nx">idle</span><span class="o">-</span><span class="nx">@_lastCPU</span><span class="p">.</span><span class="nx">idle</span>
      <span class="nv">current_irq = </span><span class="nx">irq</span><span class="o">-</span><span class="nx">@_lastCPU</span><span class="p">.</span><span class="nx">irq</span>
      <span class="nv">current_total = </span><span class="nx">current_user</span><span class="o">+</span><span class="nx">current_nice</span><span class="o">+</span><span class="nx">current_sys</span><span class="o">+</span><span class="nx">current_idle</span><span class="o">+</span><span class="nx">current_irq</span>

      <span class="vi">@_lastCPU.user = </span><span class="nx">user</span>
      <span class="vi">@_lastCPU.nice = </span><span class="nx">nice</span>
      <span class="vi">@_lastCPU.sys = </span><span class="nx">sys</span>
      <span class="vi">@_lastCPU.idle = </span><span class="nx">idle</span>
      <span class="vi">@_lastCPU.irq = </span><span class="nx">irq</span>
      <span class="vi">@_lastCPU.total = </span><span class="nx">user</span><span class="o">+</span><span class="nx">nice</span><span class="o">+</span><span class="nx">sys</span><span class="o">+</span><span class="nx">idle</span><span class="o">+</span><span class="nx">irq</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <pre><code> console.log (current_user+current_nice+current_sys+current_irq) / current_total
 console.log current_idle / current_total
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="mi">1000</span>

  <span class="nv">addRoutingToMethod : </span><span class="nf">( path, method, indexOfController ) -&gt;</span>
    <span class="nx">@routeToMethod</span><span class="p">[</span> <span class="nx">path</span> <span class="p">]</span> <span class="o">=</span>
      <span class="s">&#39;method&#39;</span> <span class="o">:</span> <span class="nx">method</span>
      <span class="s">&#39;object&#39;</span> <span class="o">:</span> <span class="nx">indexOfController</span>
    <span class="vi">@newRoutingAvaiable = </span><span class="kc">true</span>
    <span class="nx">path</span>

  <span class="nv">parseControllerRoutes : </span><span class="nf">( indexOfController ) -&gt;</span>
    <span class="nv">ControllerObject = </span><span class="nx">@controllerInstances</span><span class="p">[</span> <span class="nx">indexOfController</span> <span class="p">]</span>
    <span class="nx">unless</span> <span class="nx">ControllerObject</span><span class="p">.</span><span class="nx">getRoutes</span>
      <span class="k">return</span> <span class="kc">false</span>

    <span class="nv">controllerRoutes = </span><span class="nx">ControllerObject</span><span class="p">.</span><span class="nx">getRoutes</span><span class="p">()</span>
    <span class="k">for</span> <span class="nx">path</span> <span class="k">of</span> <span class="nx">controllerRoutes</span>
      <span class="nx">@addRoutingToMethod</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">controllerRoutes</span><span class="p">[</span> <span class="nx">path</span> <span class="p">],</span> <span class="nx">indexOfController</span>
  
  <span class="nv">loadController      : </span><span class="nf">( controllerFilename ) -&gt;</span>
    <span class="nx">unless</span> <span class="nx">controllerFilename</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\.js$/gi</span><span class="p">)</span>
      <span class="kc">false</span>

    <span class="k">if</span> <span class="nx">controllerFilename</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
      <span class="nv">controllerFilename = </span><span class="nx">@config</span><span class="p">.</span><span class="nx">baseDirectory</span> <span class="o">+</span> <span class="nx">controllerFilename</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="nv">ControllerObject = </span><span class="k">new</span> <span class="p">(</span><span class="nx">require</span> <span class="nx">controllerFilename</span><span class="p">)()</span>
    <span class="nx">ControllerObject</span><span class="p">.</span><span class="nx">bootstrap</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span> <span class="k">if</span> <span class="nx">ControllerObject</span><span class="p">.</span><span class="nx">bootstrap</span>
    <span class="nx">@parseControllerRoutes</span> <span class="nx">@controllerInstances</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">ControllerObject</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>

  <span class="nv">work: </span><span class="nf">( ControllerObject ) -&gt;</span>

    <span class="nv">instanceClass = </span><span class="k">new</span> <span class="nx">ControllerObject</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">instanceClass</span><span class="p">.</span><span class="nx">bootstrap</span> <span class="o">or</span> <span class="nx">instanceClass</span><span class="p">.</span><span class="nx">getRoutes</span>
      <span class="nv">ControllerObject = </span><span class="nx">instanceClass</span>
   
    <span class="nx">ControllerObject</span><span class="p">.</span><span class="nx">bootstrap</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span> <span class="k">if</span> <span class="nx">ControllerObject</span><span class="p">.</span><span class="nx">bootstrap</span>
    <span class="nx">@parseControllerRoutes</span> <span class="nx">@controllerInstances</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">ControllerObject</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>

  <span class="nv">assemble: </span><span class="nf">( directory ) -&gt;</span>
    <span class="nv">fullPath = </span><span class="nx">Common</span><span class="p">.</span><span class="nx">Path</span><span class="p">.</span><span class="nx">normalize</span><span class="p">(</span> <span class="nx">directory</span> <span class="p">)</span>
    <span class="k">if</span> <span class="nx">Common</span><span class="p">.</span><span class="nx">Path</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span> <span class="nx">fullPath</span> <span class="p">)</span>
      <span class="nv">files = </span><span class="nx">Common</span><span class="p">.</span><span class="nx">Fs</span><span class="p">.</span><span class="nx">readdirSyncR</span><span class="p">(</span> <span class="nx">fullPath</span> <span class="p">)</span>
      <span class="k">for</span> <span class="nx">file</span> <span class="k">in</span> <span class="nx">files</span>
        <span class="nv">valid = </span><span class="kc">false</span>
        <span class="k">if</span> <span class="nx">file</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/\.js/gi</span>
          <span class="nv">valid = </span><span class="kc">true</span>
        <span class="k">if</span> <span class="nx">file</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/\.coffee/gi</span>
          <span class="nv">valid = </span><span class="kc">true</span>
        <span class="k">if</span> <span class="nx">file</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/src\//gi</span>
          <span class="nv">valid = </span><span class="kc">false</span>
        <span class="k">if</span> <span class="nx">file</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/\.swp/gi</span>
          <span class="nv">valid = </span><span class="kc">false</span>
        <span class="k">if</span> <span class="nx">valid</span>
          <span class="nx">@work</span> <span class="nx">require</span> <span class="nx">file</span>

  <span class="nv">registerObject : </span><span class="nf">( objectName, object ) -&gt;</span>
    <span class="nx">global</span><span class="p">.</span><span class="nx">objects</span><span class="p">[</span> <span class="nx">objectName</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">object</span>
    <span class="kc">true</span>

  <span class="nv">buildObject: </span><span class="nf">(objectName) -&gt;</span>
    <span class="k">new</span> <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">objects</span><span class="p">[</span> <span class="nx">objectName</span> <span class="p">])</span>

  <span class="nv">getRawObjects: </span><span class="nf">() -&gt;</span>
    <span class="nx">global</span><span class="p">.</span><span class="nx">objects</span>

  <span class="nv">contructRoutingForPattern : </span><span class="nf">( pattern ) -&gt;</span>
    <span class="nv">params = </span><span class="p">[]</span>
    <span class="nv">buildPattern = </span><span class="nx">pattern</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/\{(.*?)\}/g</span><span class="p">,</span>
      <span class="nf">( match, sub1 ) -&gt;</span>
        <span class="nx">params</span><span class="p">.</span><span class="nx">push</span> <span class="nx">sub1</span>
        <span class="k">return</span> <span class="s">&#39;([^\/]+)&#39;</span>
    <span class="nv">buildPattern = </span><span class="nx">buildPattern</span><span class="p">.</span><span class="nx">replaceLast</span><span class="p">(</span> <span class="s">&#39;([^\/]+)&#39;</span><span class="p">,</span> <span class="s">&#39;([^$]+)&#39;</span> <span class="p">)</span>
    <span class="nv">constructedRoute =</span>
      <span class="nv">regex : </span><span class="k">new</span> <span class="nb">RegExp</span> <span class="s">&#39;^&#39;</span> <span class="o">+</span> <span class="nx">buildPattern</span> <span class="o">+</span> <span class="s">&#39;$&#39;</span>
      <span class="nv">params: </span><span class="nx">params</span>
      <span class="nv">index : </span><span class="nx">pattern</span>

  <span class="nv">buildRouting : </span><span class="o">-&gt;</span>
    <span class="nv">orderedRouteNames = </span><span class="nx">Underscore</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span> <span class="nx">@routeToMethod</span> <span class="p">).</span><span class="nx">sort</span><span class="p">().</span><span class="nx">reverse</span><span class="p">()</span>
    <span class="vi">@avaiableRoutes = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">pattern</span> <span class="k">in</span> <span class="nx">orderedRouteNames</span>
      <span class="nx">@avaiableRoutes</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@contructRoutingForPattern</span><span class="p">(</span> <span class="nx">pattern</span> <span class="p">)</span>

  <span class="nv">build: </span><span class="o">-&gt;</span>
    <span class="nx">@buildRouting</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>TODO => development = true???</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@PublicExposer</span><span class="p">.</span><span class="nx">build</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="kc">true</span> <span class="p">)</span>

  <span class="nv">parseRequest : </span><span class="nf">( request ) -&gt;</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">setEncoding</span> <span class="s">&#39;utf-8&#39;</span>
    <span class="nv">url = </span><span class="nx">Common</span><span class="p">.</span><span class="nx">Url</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="kc">true</span>
    <span class="nv">request.documentRequested = </span><span class="nx">url</span><span class="p">.</span><span class="nx">pathname</span>
    <span class="nv">request.query = </span><span class="nx">url</span><span class="p">.</span><span class="nx">query</span>

  <span class="nv">parseLocaleFromRequest : </span><span class="nf">( request ) -&gt;</span>
    <span class="nv">language = </span><span class="s">&#39;en&#39;</span>
    <span class="k">if</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">defaultLocale</span>
      <span class="nv">language = </span><span class="nx">@config</span><span class="p">.</span><span class="nx">defaultLocale</span>
    <span class="k">if</span> <span class="nx">request</span><span class="p">.</span><span class="nx">documentRequested</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/^\/(([a-z]{1,2})(\-[a-z]{1,2})?)($|\/)/ig</span>
      <span class="nv">requestedLocale = </span><span class="nb">RegExp</span><span class="p">.</span><span class="nx">$1</span>
      <span class="nv">request.documentRequested = </span><span class="nx">request</span><span class="p">.</span><span class="nx">documentRequested</span><span class="p">.</span><span class="nx">replace</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">requestedLocale</span><span class="p">,</span> <span class="s">&#39;&#39;</span>
    <span class="nv">request.documentRequested = </span><span class="s">&#39;/&#39;</span> <span class="k">if</span> <span class="nx">request</span><span class="p">.</span><span class="nx">documentRequested</span> <span class="o">==</span> <span class="s">&#39;&#39;</span>
    <span class="nv">request.documentLocale = </span><span class="nx">language</span>

  <span class="nv">buildParamsForRequest: </span><span class="nf">( route, args, otherParams ) -&gt;</span>
    <span class="nv">params = </span><span class="p">{}</span>
    <span class="k">for</span> <span class="nx">index</span> <span class="k">of</span> <span class="nx">route</span><span class="p">.</span><span class="nx">params</span>
      <span class="nx">params</span><span class="p">[</span> <span class="nx">route</span><span class="p">.</span><span class="nx">params</span><span class="p">[</span> <span class="nx">index</span> <span class="p">]</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span> <span class="p">]</span>
    <span class="nx">Underscore</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">otherParams</span> <span class="p">)</span>
    <span class="nx">params</span>

  <span class="nv">callMethodForRoute : </span><span class="nf">( route, params ) -&gt;</span>
    <span class="k">if</span> <span class="nx">@routeToMethod</span><span class="p">[</span> <span class="nx">route</span><span class="p">.</span><span class="nx">index</span> <span class="p">]</span>
      <span class="nv">ControllerIndex = </span><span class="nx">@routeToMethod</span><span class="p">[</span> <span class="nx">route</span><span class="p">.</span><span class="nx">index</span> <span class="p">].</span><span class="nx">object</span>
      <span class="nv">ControllerObject = </span><span class="nx">@controllerInstances</span><span class="p">[</span> <span class="nx">ControllerIndex</span> <span class="p">]</span>
      <span class="nx">ControllerObject</span><span class="p">[</span> <span class="nx">@routeToMethod</span><span class="p">[</span> <span class="nx">route</span><span class="p">.</span><span class="nx">index</span> <span class="p">].</span><span class="nx">method</span> <span class="p">](</span> <span class="nx">params</span> <span class="p">)</span>
    <span class="k">else</span>
      <span class="kc">false</span>

  <span class="nv">respondWithError : </span><span class="nf">( respond ) -&gt;</span>
    <span class="nx">respond</span><span class="p">.</span><span class="nx">respondWith</span> <span class="nx">@Template</span><span class="p">.</span><span class="nx">doRender</span><span class="p">(</span> <span class="s">&#39;500&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="p">{},</span> <span class="kc">false</span> <span class="p">),</span> <span class="mi">500</span>

  <span class="nv">respondWithTimeout: </span><span class="nf">( respond ) -&gt;</span>
    <span class="nx">respond</span><span class="p">.</span><span class="nx">respondWith</span> <span class="nx">@Template</span><span class="p">.</span><span class="nx">doRender</span><span class="p">(</span> <span class="s">&#39;500&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="p">{},</span> <span class="kc">false</span><span class="p">),</span> <span class="mi">504</span>

  <span class="nv">respondWithNotFound: </span><span class="nf">( respond ) -&gt;</span>
    <span class="nx">respond</span><span class="p">.</span><span class="nx">respondWith</span> <span class="nx">@Template</span><span class="p">.</span><span class="nx">doRender</span><span class="p">(</span> <span class="s">&#39;404&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="p">{},</span> <span class="kc">false</span> <span class="p">),</span> <span class="mi">404</span><span class="p">,</span> <span class="mi">300</span>

  <span class="nv">dispatchRequest : </span><span class="nf">( request, response ) -&gt;</span>
    <span class="nx">@parseRequest</span><span class="p">(</span> <span class="nx">request</span> <span class="p">)</span>
    <span class="nx">@parseLocaleFromRequest</span><span class="p">(</span> <span class="nx">request</span> <span class="p">)</span>

    <span class="nv">data = </span><span class="s">&#39;&#39;</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">addListener</span> <span class="s">&#39;data&#39;</span><span class="p">,</span> <span class="p">(</span> <span class="nx">data_chunk</span> <span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">data</span> <span class="o">+=</span> <span class="nx">data_chunk</span>

    <span class="nx">request</span><span class="p">.</span><span class="nx">addListener</span> <span class="s">&#39;end&#39;</span><span class="p">,</span> <span class="o">=&gt;</span>
      <span class="vi">@_requestsCounter = </span><span class="nx">@_requestsCounter</span><span class="o">+</span><span class="mi">1</span>
      <span class="nv">hasRouted = </span><span class="kc">false</span>

      <span class="k">for</span> <span class="nx">route</span> <span class="k">in</span> <span class="nx">@avaiableRoutes</span>
        <span class="nv">routeMatches = </span><span class="nx">route</span><span class="p">.</span><span class="nx">regex</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span> <span class="nx">request</span><span class="p">.</span><span class="nx">documentRequested</span> <span class="p">)</span>
        <span class="k">if</span> <span class="nx">routeMatches</span>
          <span class="nv">params = </span><span class="nx">@buildParamsForRequest</span><span class="p">(</span> <span class="nx">route</span><span class="p">,</span> <span class="nx">routeMatches</span><span class="p">,</span> <span class="p">{</span>
            <span class="nv">request  : </span><span class="nx">request</span>
            <span class="nv">response : </span><span class="nx">response</span>
            <span class="nv">route    : </span><span class="nx">route</span><span class="p">.</span><span class="nx">index</span>
            <span class="nv">app      : </span><span class="k">this</span>
          <span class="p">})</span>
          <span class="k">try</span>        <span class="c1"># Execute the method in a sandbox</span>
            <span class="nv">hasRouted = </span><span class="nx">@callMethodForRoute</span><span class="p">(</span> <span class="nx">route</span><span class="p">,</span> <span class="nx">params</span> <span class="p">)</span> <span class="nx">unless</span> <span class="nx">hasRouted</span>
          <span class="k">catch</span> <span class="nx">error</span>
            <span class="nx">@respondWithError</span> <span class="nx">response</span>
            <span class="nv">hasRouted = </span><span class="kc">true</span>
        
        <span class="k">if</span> <span class="nx">hasRouted</span>
          <span class="k">break</span>

      <span class="nx">unless</span> <span class="nx">hasRouted</span>
        <span class="nx">@respondWithNotFound</span> <span class="nx">response</span>

  <span class="nv">createServer : </span><span class="o">-&gt;</span>
    <span class="nx">Common</span><span class="p">.</span><span class="nx">Http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span> <span class="nx">@dispatchRequest</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span> <span class="p">)</span>

  <span class="nv">createSecureServer: </span><span class="nf">( privateKey, certificate ) -&gt;</span>
    <span class="nv">crypto = </span><span class="nx">require</span> <span class="s">&#39;crypto&#39;</span>
    <span class="nv">credentials = </span><span class="nx">crypto</span><span class="p">.</span><span class="nx">createCredentials</span> <span class="p">{</span>
      <span class="nv">key: </span><span class="nx">privateKey</span>
      <span class="nv">cert: </span><span class="nx">certificate</span>
    <span class="p">}</span>
    <span class="nv">secureServer = </span><span class="nx">Common</span><span class="p">.</span><span class="nx">Http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span> <span class="nx">@dispatchRequest</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">)</span>
    <span class="nx">secureServer</span><span class="p">.</span><span class="nx">setSecure</span><span class="p">(</span> <span class="nx">credentials</span> <span class="p">)</span>
    <span class="nx">secureServer</span>

<span class="nv">module.exports = </span><span class="nx">Arcabouco</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 